<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, 
initial-scale=1.0">
    <title>Lanternfly Tracker</title>
</head>
<body>
    <h1>Lanternfly Tracker</h1>
    <input type="file" id="f" accept="image/*" 
capture="environment">
    <button onclick="send()">Upload</button>

    <h2>Gallery</h2>
    <div id="gallery"></div>

    <script>
    async function send(){
        const fd = new FormData();
        const file = document.getElementById("f").files[0];
        if(!file){
            alert('Please choose a file first.');
            return;
        }
        fd.append("file", file);

        try{
            const r = await fetch("/api/v1/upload", { method: "POST", body: fd });
            const ctype = r.headers.get('content-type') || '';
            let j = null;
            if(ctype.indexOf('application/json') !== -1){
                try{ j = await r.json(); } catch(e){
                    console.error('Failed to parse JSON response', e);
                }
            } else {
                const text = await r.text();
                console.warn('Non-JSON response for upload:', text.slice(0,500));
            }

            if(!r.ok){
                const msg = (j && j.error) ? j.error : `Upload failed: ${r.status} ${r.statusText}`;
                alert(msg);
                return;
            }

            if(j && j.url){
                alert("Uploaded: " + j.url);
            } else {
                alert('Upload succeeded but response did not include URL.');
            }
            loadGallery();
        } catch(err){
            console.error('Upload request failed', err);
            alert('Upload request failed: ' + err.message);
        }
    }

    async function loadGallery(){
        try{
            const r = await fetch("/api/v1/gallery");
            const ctype = r.headers.get('content-type') || '';
            let j = null;
            if(ctype.indexOf('application/json') !== -1){
                try{ j = await r.json(); } catch(e){ console.error('Invalid JSON from gallery', e); }
            } else {
                const text = await r.text();
                console.warn('Non-JSON response for gallery:', text.slice(0,500));
            }

            const galleryDiv = document.getElementById("gallery");
            galleryDiv.innerHTML = "";
            if(r.ok && j && j.ok && Array.isArray(j.gallery)){
                j.gallery.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.style.maxWidth = "200px";
                    img.style.margin = "5px";
                    const caption = document.createElement("div");
                    caption.textContent = url.split("/").pop();
                    galleryDiv.appendChild(img);
                    galleryDiv.appendChild(caption);
                });
            } else if(!r.ok){
                console.warn('Gallery request failed', r.status, r.statusText);
            }
        } catch(err){
            console.error('Failed to load gallery', err);
        }
    }

    loadGallery(); // load gallery on page load
    </script>
</body>
</html>